#!/bin/bash
set -euo pipefail

TERMINAL=${TERMINAL:-alacritty}

get_dir() {
  focused_pid=$(hyprctl activewindow -j 2>/dev/null | jq -r '.pid // empty')

  if [ -n "$focused_pid" ] && [ -r "/proc/$focused_pid/cwd" ]; then
    readlink -f "/proc/$focused_pid/cwd"
    return
  fi

  active_workspace=$(hyprctl activeworkspace -j | jq -r '.id // empty')
  if [ -n "$active_workspace" ]; then
    window_pid=$(hyprctl clients -j | jq -r --arg id "$active_workspace" '.[] | select(.workspace.id == ($id|tonumber)) | .pid' | head -n1)
    if [ -n "$window_pid" ] && [ -r "/proc/$window_pid/cwd" ]; then
      readlink -f "/proc/$window_pid/cwd"
      return
    fi
  fi

  echo "$HOME"
}

DIR=$(get_dir)
exec "$TERMINAL" --working-directory="$DIR"
